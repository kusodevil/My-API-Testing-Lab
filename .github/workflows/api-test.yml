name: API Automated Testing

on:
  # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches:
      - main

  # å®šæ™‚è§¸ç™¼ï¼šç›®æ¨™ç‚ºå°ç£æ™‚é–“æ—©ä¸Š 9:00 åŸ·è¡Œ
  # Cron èªæ³•ä½¿ç”¨ UTC æ™‚é–“ï¼Œå°ç£ GMT+8 éœ€è¦æ¸› 8 å°æ™‚
  #
  # ç†è«–å€¼ï¼šUTC 01:00 = å°ç£æ™‚é–“ 09:00
  # å¯¦éš›è§€å¯Ÿï¼šé€±æœ«å»¶é²ç´„ 3 å°æ™‚ï¼ˆå¾ 09:00 å»¶é²åˆ° 12:00ï¼‰
  #
  # è§£æ±ºæ–¹æ¡ˆï¼šæå‰ 3 å°æ™‚è§¸ç™¼ï¼Œè¨­å®šç‚º UTC 22:00ï¼ˆå‰ä¸€å¤©ï¼‰
  # UTC 22:00ï¼ˆå‰ä¸€å¤©ï¼‰â†’ ç†è«–ä¸Šå°ç£æ™‚é–“ 06:00 â†’ åŠ ä¸Šå»¶é² 3hr â‰ˆ å°ç£æ™‚é–“ 09:00
  schedule:
    - cron: '0 22 * * *'

  # å…è¨±åœ¨ GitHub Actions é é¢æ‰‹å‹•è§¸ç™¼åŸ·è¡Œ
  workflow_dispatch:

# GitHub Actions æ¬Šé™è¨­å®š
# - contents: read   => è®€å–å°ˆæ¡ˆæª”æ¡ˆ
# - pages: write     => å¯«å…¥ GitHub Pages
# - id-token: write  => å¯«å…¥ OIDC token (ç”¨æ–¼å®‰å…¨éƒ¨ç½²)
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-api:
    runs-on: ubuntu-latest

    # è¨­å®šéƒ¨ç½²ç’°å¢ƒç‚º GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # Step 1: ç°½å‡ºç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: å®‰è£ Node.js ç’°å¢ƒ
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3: å…¨åŸŸå®‰è£ Newman CLI åŠ HTML å ±å‘Šç”¢ç”Ÿå™¨
      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      # Step 4: å®‰è£å°ˆæ¡ˆä¾è³´ (Puppeteer)
      - name: Install Dependencies
        run: npm install

      # Step 5: è‡ªå‹•æ›´æ–° IAP Cookie
      # ä½¿ç”¨ Puppeteer è‡ªå‹•ç™»å…¥å…¬å¸ç¶²ç«™ï¼Œå–å¾—æœ€æ–°çš„èªè­‰ Cookie
      # éœ€è¦ 4 å€‹ç’°å¢ƒè®Šæ•¸ï¼šIAP å¸³å¯† + å…¬å¸ç³»çµ±å¸³å¯†
      - name: Update Company Cookie
        run: npm run update-cookie
        env:
          IAP_EMAIL: ${{ secrets.IAP_EMAIL }}
          IAP_PASSWORD: ${{ secrets.IAP_PASSWORD }}
          COMPANY_EMAIL: ${{ secrets.COMPANY_EMAIL }}
          COMPANY_PASSWORD: ${{ secrets.COMPANY_PASSWORD }}

      # Step 6: åŸ·è¡Œ Petstore API æ¸¬è©¦ï¼ˆç¯„ä¾‹ï¼‰
      # ä½¿ç”¨ Newman åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆ HTML å ±å‘Š
      - name: Run API Tests
        run: |
          newman run "Swagger Petstore.postman_collection.json" \
          -d pet-data.json \
          --env-var "api_key=${{ secrets.MY_SECRET_KEY }}" \
          -r htmlextra \
          --reporter-htmlextra-export index.html

      # Step 7: åŸ·è¡Œå…¬å¸ API æ¸¬è©¦
      # ä½¿ç”¨æ›´æ–°å¾Œçš„ Cookie åŸ·è¡Œæ¸¬è©¦ï¼Œä¸¦æå–å·¥ä½œå€è³‡è¨Šä¾› Slack é€šçŸ¥ä½¿ç”¨
      - name: Run Company API Test
        run: |
          # åŸ·è¡Œ Newman æ¸¬è©¦ä¸¦åŒ¯å‡ºç’°å¢ƒè®Šæ•¸åˆ°æª”æ¡ˆ
          newman run ./Kolr.postman_collection.json \
          -e ./STG-Env.postman_environment.json \
          --env-var "company_cookie=${{ secrets.COMPANY_COOKIE }}" \
          --reporters cli \
          --export-environment ./STG-Env-output.postman_environment.json

          # å¾è¼¸å‡ºçš„ç’°å¢ƒè®Šæ•¸æª”æ¡ˆä¸­æå–å·¥ä½œå€è³‡è¨Š
          WORKSPACE_COUNT=$(jq -r '.values[] | select(.key=="workspace_count") | .value' STG-Env-output.postman_environment.json)
          ALL_WORKSPACE_NAMES=$(jq -r '.values[] | select(.key=="all_workspace_names") | .value' STG-Env-output.postman_environment.json)

          # æå–æ•ˆèƒ½è­¦å‘Šç‹€æ…‹
          PERFORMANCE_WARNING=$(jq -r '.values[] | select(.key=="performance_warning") | .value' STG-Env-output.postman_environment.json)
          PERFORMANCE_TIME=$(jq -r '.values[] | select(.key=="performance_time") | .value' STG-Env-output.postman_environment.json)

          # å°‡è®Šæ•¸å­˜å…¥ GitHub ç’°å¢ƒè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "WORKSPACE_COUNT=${WORKSPACE_COUNT}" >> $GITHUB_ENV
          echo "ALL_WORKSPACE_NAMES=${ALL_WORKSPACE_NAMES}" >> $GITHUB_ENV
          echo "PERFORMANCE_WARNING=${PERFORMANCE_WARNING}" >> $GITHUB_ENV
          echo "PERFORMANCE_TIME=${PERFORMANCE_TIME}" >> $GITHUB_ENV

          # Debug: é¡¯ç¤ºæå–çš„å€¼ï¼ˆæ–¹ä¾¿è¿½è¹¤å•é¡Œï¼‰
          echo "æå–çš„å·¥ä½œå€æ•¸é‡: ${WORKSPACE_COUNT}"
          echo "æå–çš„å·¥ä½œå€åç¨±: ${ALL_WORKSPACE_NAMES}"
          echo "æ•ˆèƒ½è­¦å‘Šç‹€æ…‹: ${PERFORMANCE_WARNING}"
          echo "å›æ‡‰æ™‚é–“: ${PERFORMANCE_TIME}ms"

      # Step 8: è¨­å®š GitHub Pages
      # æº–å‚™å°‡æ¸¬è©¦å ±å‘Šéƒ¨ç½²åˆ° GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Step 9: ä¸Šå‚³æ¸¬è©¦å ±å‘Šæª”æ¡ˆ
      # å°‡ç”Ÿæˆçš„ index.html æ¸¬è©¦å ±å‘Šä¸Šå‚³ç‚º Pages artifact
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      # Step 10: éƒ¨ç½²åˆ° GitHub Pages
      # å°‡æ¸¬è©¦å ±å‘Šç™¼å¸ƒåˆ° https://kusodevil.github.io/My-API-Testing-Lab/
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Step 11: æº–å‚™ Slack é€šçŸ¥è¨Šæ¯
      # æ ¹æ“šæ¸¬è©¦çµæœçµ„åˆè¨Šæ¯å…§å®¹ï¼ŒåŒ…å«å·¥ä½œå€çµ±è¨ˆè³‡è¨Šå’Œæ•ˆèƒ½è­¦å‘Š
      - name: Prepare Slack Message
        if: always()  # ç„¡è«–æ¸¬è©¦æˆåŠŸæˆ–å¤±æ•—éƒ½åŸ·è¡Œ
        run: |
          # æ ¹æ“šæ¸¬è©¦çµæœå’Œæ•ˆèƒ½è­¦å‘Šæ±ºå®šç‹€æ…‹è¨Šæ¯
          if [ "${{ job.status }}" == "success" ]; then
            if [ "${PERFORMANCE_WARNING}" == "true" ]; then
              STATUS_MSG="âš ï¸ API æ¸¬è©¦é€šéï¼Œä½†æœ‰æ•ˆèƒ½è­¦ç¤ºï¼ˆ${PERFORMANCE_TIME}msï¼‰"
              SLACK_COLOR="warning"
            else
              STATUS_MSG="âœ… API æ¸¬è©¦å…¨æ•¸é€šéï¼"
              SLACK_COLOR="good"
            fi
          else
            STATUS_MSG="âŒ API æ¸¬è©¦ç™¼ç¾ Bugï¼"
            SLACK_COLOR="danger"
          fi

          # çµ„åˆå®Œæ•´çš„é€šçŸ¥è¨Šæ¯
          MESSAGE="${STATUS_MSG}

          ğŸ“‹ ${ALL_WORKSPACE_NAMES}

          ğŸ“Š æ¸¬è©¦å ±å‘Šï¼šhttps://kusodevil.github.io/My-API-Testing-Lab/"

          # ä½¿ç”¨ heredoc å°‡å¤šè¡Œè¨Šæ¯å­˜å…¥ç’°å¢ƒè®Šæ•¸
          echo "SLACK_MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # å„²å­˜ Slack é¡è‰²
          echo "SLACK_COLOR=${SLACK_COLOR}" >> $GITHUB_ENV

      # Step 12: ç™¼é€ Slack é€šçŸ¥
      # å°‡æ¸¬è©¦çµæœåŠå·¥ä½œå€çµ±è¨ˆè³‡è¨Šç™¼é€åˆ° Slack é »é“
      # é¡è‰²æœƒæ ¹æ“šæ¸¬è©¦çµæœå’Œæ•ˆèƒ½è­¦å‘Šå‹•æ…‹èª¿æ•´
      - name: Slack Notification
        if: always()  # ç„¡è«–æ¸¬è©¦æˆåŠŸæˆ–å¤±æ•—éƒ½ç™¼é€é€šçŸ¥
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: 'API æ¸¬è©¦çµæœé€šçŸ¥'
          SLACK_MESSAGE: ${{ env.SLACK_MESSAGE }}
          SLACK_COLOR: ${{ env.SLACK_COLOR }}