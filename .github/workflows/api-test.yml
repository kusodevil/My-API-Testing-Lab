name: API Automated Testing 

on:
  push:
    branches:
      - main
  # æ–°å¢å®šæ™‚è§¸ç™¼
  schedule:
    # é€™è£¡ä½¿ç”¨çš„æ˜¯ UTC æ™‚é–“ï¼Œå°ç£æ™‚é–“ (GMT+8) è¦æ¸›æ‰ 8 å°æ™‚
    # ç¯„ä¾‹ï¼šæ¯å¤©æ—©ä¸Š 9:00 (å°ç£æ™‚é–“) è·‘ä¸€æ¬¡ = UTC 1:00
    - cron: '0 1 * * *'
  # å…è¨±æ‰‹å‹•é»æ“ŠæŒ‰éˆ•åŸ·è¡Œ (æ¸¬è©¦æ™‚å¾ˆå¥½ç”¨)
  workflow_dispatch:

# åŠ å¼·æ¬Šé™è¨­å®šï¼Œè®“ Actions èƒ½å¤ æŠŠç¶²é ç™¼å¸ƒå‡ºå»
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-api:
    runs-on: ubuntu-latest
    # è¨­å®šç’°å¢ƒï¼Œé€™æœƒè·Ÿ GitHub Pages é€£çµ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Install Dependencies
        run: npm install

      - name: Update Company Cookie
        run: npm run update-cookie
        env:
          COMPANY_EMAIL: ${{ secrets.COMPANY_EMAIL }}
          COMPANY_PASSWORD: ${{ secrets.COMPANY_PASSWORD }}

      - name: Run API Tests
        run: |
          newman run "Swagger Petstore.postman_collection.json" \
          -d pet-data.json \
          --env-var "api_key=${{ secrets.MY_SECRET_KEY }}" \
          -r htmlextra \
          --reporter-htmlextra-export index.html

      - name: Run Company API Test
        run: |
          newman run ./Kolr.postman_collection.json \
          -e ./STG-Env.postman_environment.json \
          --env-var "company_cookie=${{ secrets.COMPANY_COOKIE }}" \
          --reporters cli,rtbot

      # æ–°å¢æ­¥é©Ÿï¼šå°‡ index.html æ‰“åŒ…æˆç¶²é æ ¼å¼
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.' # å°‡ç•¶å‰ç›®éŒ„ä¸‹çš„ index.html ä¸Šå‚³

      # æ–°å¢æ­¥é©Ÿï¼šæ­£å¼éƒ¨ç½²åˆ°ç¶²é ç¶²å€
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Slack Notification
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: 'API æ¸¬è©¦çµæœé€šçŸ¥'
          SLACK_MESSAGE: |
            ${{ job.status == 'success' && 'âœ… API æ¸¬è©¦å…¨æ•¸é€šéï¼' || 'âŒ API æ¸¬è©¦ç™¼ç¾ Bugï¼' }}
            ğŸ“Š å³æ™‚å„€è¡¨æ¿ï¼šhttps://kusodevil.github.io/My-API-Testing-Lab/
            (è«‹æŸ¥çœ‹ GitHub Actions ç¢ºèªå¤±æ•—è©³æƒ…)
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}