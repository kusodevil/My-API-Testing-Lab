name: API Automated Testing
on:
  push:
    branches: [ main ]

# åŠ å¼·æ¬Šé™è¨­å®šï¼Œè®“ Actions èƒ½å¤ æŠŠç¶²é ç™¼å¸ƒå‡ºå»
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-api:
    runs-on: ubuntu-latest
    # è¨­å®šç’°å¢ƒï¼Œé€™æœƒè·Ÿ GitHub Pages é€£çµ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Run API Tests
        env:
          MY_SECRET_KEY: ${{ secrets.MY_API_KEY }}
        run: |
          newman run "Swagger Petstore.postman_collection.json" \
          --env-var "api_key=$MY_SECRET_KEY" \
          -r htmlextra \
          --reporter-htmlextra-export index.html # å°‡æª”åæ”¹ç‚º index.html æ–¹ä¾¿ç¶²é è®€å–

      # æ–°å¢æ­¥é©Ÿï¼šå°‡ index.html æ‰“åŒ…æˆç¶²é æ ¼å¼
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.' # å°‡ç•¶å‰ç›®éŒ„ä¸‹çš„ index.html ä¸Šå‚³

      # æ–°å¢æ­¥é©Ÿï¼šæ­£å¼éƒ¨ç½²åˆ°ç¶²é ç¶²å€
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Slack Notification
        if: always() # ç„¡è«–æ¸¬è©¦æˆåŠŸæˆ–å¤±æ•—éƒ½è¦é€šçŸ¥ä½ 
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: 'API æ¸¬è©¦çµæœé€šçŸ¥'
          SLACK_MESSAGE: 'âœ… API æ¸¬è©¦å…¨æ•¸é€šéï¼\nğŸ“Š å³æ™‚å„€è¡¨æ¿ï¼šhttps://kusodevil.github.io/My-API-Testing-Lab/\n(æ­¤å ±å‘Šéš¨æ¯æ¬¡æ¨ä»£ç¢¼è‡ªå‹•æ›´æ–°)'
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }} # æˆåŠŸç¶ è‰²ï¼Œå¤±æ•—ç´…è‰²